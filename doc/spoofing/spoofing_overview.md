# Spoofing Overview

This document provides an overview of the data spoofing system and explains the order in which different ROS topics are spoofed to create a convincing fake robot behavior.

## Purpose

The spoofing system generates a modified bag file where the robot appears to complete its navigation mission, even though the actual movement data after the 50% mark is fabricated. This is useful for:
- Research on autonomous system vulnerabilities
- Studying human-robot trust and operator awareness
- Testing operator response to spoofed data

---

## Spoofing Order

The topics are spoofed in a specific order to maintain consistency and believability. The order follows the logical chain of dependencies in a robotic system: **Map (Environment) â†’ Sensors (Perception) â†’ Costmap (Representation) â†’ Path (Planning) â†’ TF (Pose) â†’ cmd_vel (Control)**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SPOOFING PIPELINE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   1. Map â”€â”€â–º 2. LiDAR â”€â”€â–º 3. Costmap â”€â”€â–º 4. Path â”€â”€â–º 5. TF â”€â”€â–º 6. cmd_vel  â”‚
â”‚   (Memory)   (Sensor)     (Planning)     (Goal)      (Pose)    (Motors)    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. Map (Internal Memory)

**Topic:** `/map`  
**Type:** `nav_msgs/OccupancyGrid`  
**Spoofing Method:** Frozen replay

| Aspect | Description |
|--------|-------------|
| **Purpose** | Static SLAM-built map of the environment |
| **How Spoofed** | Replays the last map state from before the 50% mark |
| **Why First** | The map is the ground truth. All other data (lidar, costmap, path) must be consistent with this map. |

The map typically doesn't change rapidly, so freezing it is natural and hard to detect. It serves as the canvas for the rest of the spoofing.

---

## 2. LiDAR (Perception Input)

**Topic:** `/scan`  
**Type:** `sensor_msgs/LaserScan`  
**Spoofing Method:** Generated (Raycasting against the Map) or Frozen

| Aspect | Description |
|--------|-------------|
| **Purpose** | Raw sensor input that feeds obstacle detection |
| **How Spoofed** | Ideally generated by raycasting against the frozen map to match the fake position, or frozen if simple. |
| **Why Second** | Sensors observe the environment (Map). If the map says there is a wall, the LiDAR must see a wall. |

```
Real Environment         Spoofed View (Consistent with Map)
      â”Œâ”€â”€â”€â”                 â”Œâ”€â”€â”€â”
  â•â•â•— â”‚   â”‚ â•”â•â•         â•â•â•— â”‚   â”‚ â•”â•â•
    â•‘ â”‚ğŸ¤– â”‚ â•‘             â•‘ â”‚ğŸ¤– â”‚ â•‘
  â•â•â• â”‚   â”‚ â•šâ•â•         â•â•â• â”‚   â”‚ â•šâ•â•
      â””â”€â”€â”€â”˜                 â””â”€â”€â”€â”˜
  (obstacles)           (matches the frozen map)
```

---

## 3. Costmap (Representation Input)

**Topic:** `/global_costmap/costmap`, `/local_costmap/costmap`  
**Type:** `nav_msgs/OccupancyGrid`  
**Spoofing Method:** Generated/Frozen

| Aspect | Description |
|--------|-------------|
| **Purpose** | Occupancy grid used by navigation stack for path planning |
| **How Spoofed** | Derived from the Map and LiDAR data. |
| **Why Third** | The costmap is built *from* the sensor data and the map. It represents where the robot can safely go. |

The costmap shows the operator that:
- The navigation area is clear
- The planned path has no obstacles
- The robot "should" be able to complete its mission

---

## 4. Nav2 Path (Planning)

**Topic:** `/plan`  
**Type:** `nav_msgs/Path`  
**Spoofing Method:** Frozen replay or Re-planned

| Aspect | Description |
|--------|-------------|
| **Purpose** | The planned navigation path to the goal (the "green line") |
| **How Spoofed** | Replays the last navigation plan or generates a new one based on the Costmap. |
| **Why Fourth** | The path planner looks at the Costmap to find a valid route. It must avoid obstacles shown in the Costmap. |

The navigation path:
- Shows a valid route to the destination
- Confirms the autonomous planner is "working"
- Provides the trajectory that fake positions follow

```
                      Goal
                       ğŸ¯
                      /
    [Plan Path]      /
                    /
                   /
              ğŸ¤–  /
            (fake position follows this path)
```

---

## 5. TF Tree (Localization)

**Topic:** `/tf`, `/tf_static`  
**Type:** `tf2_msgs/TFMessage`  
**Spoofing Method:** Generated (fake positions interpolated along nav path)

| Aspect | Description |
|--------|-------------|
| **Purpose** | Robot's position and orientation in the world |
| **How Spoofed** | Fake `odomâ†’base_link` transforms generated to show smooth movement along the Path. |
| **Why Fifth** | The robot tries to follow the Path. Its position is a result of that attempt. Also, speed depends on the Costmap (slowing down near walls). |

**Key transforms spoofed:**
```
map â”€â”€(identity)â”€â”€â–º odom â”€â”€(FAKE x,y,yaw)â”€â”€â–º base_link
                                              â”‚
                                    (copied tf_static)
                                              â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â–¼                   â–¼                   â–¼
                    lidar_link           imu_link          wheel_links
```

See [tf_spoofing.md](./tf_spoofing.md) for detailed explanation.

---

## 6. cmd_vel (Actuation)

**Topic:** `/cmd_vel`  
**Type:** `geometry_msgs/Twist`  
**Spoofing Method:** Generated (calculated from fake velocity)

| Aspect | Description |
|--------|-------------|
| **Purpose** | Velocity commands sent to motor controllers |
| **How Spoofed** | Generates linear velocity matching the fake movement derived from TF. |
| **Why Last** | Motor commands are the output of the control loop, trying to achieve the desired movement. They must match the observed TF movement. |

```python
# Fake cmd_vel matches the fake movement
odom_msg.twist.twist.linear.x = 0.5  # m/s forward
odom_msg.twist.twist.angular.z = 0   # no rotation (path is interpolated)
```

This shows the operator that:
- The robot is actively driving
- Motor commands are being issued
- The system is "working normally"

---

## Timeline Visualization

```
Original Bag Duration: |â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•|
                       0%                    50%                        100%

First Half (COPIED):   |â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•|
                       Real Map âœ“
                       Real LiDAR âœ“
                       Real Costmaps âœ“
                       Real Plan âœ“
                       Real TF âœ“
                       Real cmd_vel âœ“

Second Half (SPOOFED):                         |â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•|
                                               Frozen Map â– 
                                               Frozen/Gen LiDAR â– 
                                               Frozen/Gen Costmaps â– 
                                               Frozen/Gen Plan â– 
                                               FAKE TF (generated) â–²
                                               FAKE cmd_vel (generated) â–²
```

---

## Detection Resistance

The spoofing order is designed to be hard to detect:

| Topic | Why Hard to Detect |
|-------|-------------------|
| Map | Maps are expected to be static |
| LiDAR | Consistent with the map (if raycasted) or frozen |
| Costmap | Consistent with LiDAR and Map |
| Path | Valid path on the Costmap |
| TF | Shows smooth, believable motion following the Path |
| cmd_vel | Matches the observed movement |

---

## Code Reference

Main implementation: [`backend/bag/spoofer.py`](../backend/bag/spoofer.py)

- `generate_spoofed_bag()` - Orchestrates the entire spoofing process
- `frozen_topics` list - Defines which topics are frozen vs generated

---

## Related Documentation

- [TF Tree Spoofing](./tf_spoofing.md) - Detailed explanation of position spoofing
- *(Future)* [LiDAR Spoofing](./lidar_spoofing.md)
- *(Future)* [Costmap Spoofing](./costmap_spoofing.md)
- *(Future)* [cmd_vel Spoofing](./cmdvel_spoofing.md)
